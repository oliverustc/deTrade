#!/bin/bash
Nums_Org=${1:-"20"}
Nums_Peer=${2:-"25"}
function one_line_pem {
    echo "`awk 'NF {sub(/\\n/, ""); printf "%s\\\\\\\n",$0;}' $1`"
}

function json_ccp {
    local DP=$(one_line_pem ${!#-2})  # Third to last argument
    local PP=$(one_line_pem ${!#-1})  # Second to last argument
    local CP=$(one_line_pem ${!#})    # Last argument
    
    # Start with basic substitutions
    local SED_COMMANDS="-e s#\${ORG}#$1#"
    
    # Dynamically add port substitutions based on Nums_Peer
    for ((i=0; i<${Nums_Peer}; i++)); do
        port_index=$((i+2))  # Start from 2 since $1 is ORG
        SED_COMMANDS+=("-e" "s#\${P${i}PORT}#${!port_index}#g")
    done
    
    # Add final substitutions
    SED_COMMANDS+=("-e" "s#\${CAPORT}#$DP#g")
    SED_COMMANDS+=("-e" "s#\${PEERPEM}#$PP#g")
    SED_COMMANDS+=("-e" "s#\${CAPEM}#$CP#g")
    
    # Execute sed with all commands
    sed "${SED_COMMANDS[@]}" organizations/ccp-template-deTrade.json
}

function yaml_ccp {
    local DP=$(one_line_pem ${!#-2})  # Third to last argument
    local PP=$(one_line_pem ${!#-1})  # Second to last argument
    local CP=$(one_line_pem ${!#})    # Last argument
    
    # Start with basic substitutions
    local SED_COMMANDS="-e s#\${ORG}#$1#"
    
    # Dynamically add port substitutions based on Nums_Peer
    for ((i=0; i<${Nums_Peer}; i++)); do
        port_index=$((i+2))  # Start from 2 since $1 is ORG
        SED_COMMANDS+=("-e" "s#\${P${i}PORT}#${!port_index}#g")
    done
    
    # Add final substitutions
    SED_COMMANDS+=("-e" "s#\${CAPORT}#$DP#g")
    SED_COMMANDS+=("-e" "s#\${PEERPEM}#$PP#g")
    SED_COMMANDS+=("-e" "s#\${CAPEM}#$CP#g")
    
    # Execute sed with all commands and handle newlines
    sed "${SED_COMMANDS[@]}" organizations/ccp-template-deTrade.yaml | sed -e $'s/\\\\n/\\\n          /g'
}


# 定义组织信息
declare -a orgs=(1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20)
# Port mappings for 20 organizations
declare -A PEER_PORTS=(
  # Org1 peers (base: 7000)
  ["1,0"]=7051 ["1,1"]=7151 ["1,2"]=7251 ["1,3"]=7351 ["1,4"]=7451 ["1,5"]=7551 ["1,6"]=7651 ["1,7"]=7751 ["1,8"]=7851 ["1,9"]=7951
  ["1,10"]=7061 ["1,11"]=7161 ["1,12"]=7261 ["1,13"]=7361 ["1,14"]=7461 ["1,15"]=7561 ["1,16"]=7661 ["1,17"]=7761 ["1,18"]=7861 ["1,19"]=7961
  ["1,20"]=7071 ["1,21"]=7171 ["1,22"]=7271 ["1,23"]=7371 ["1,24"]=7471

  # Org2 peers (base: 8000)
  ["2,0"]=8051 ["2,1"]=8151 ["2,2"]=8251 ["2,3"]=8351 ["2,4"]=8451 ["2,5"]=8551 ["2,6"]=8651 ["2,7"]=8751 ["2,8"]=8851 ["2,9"]=8951
  ["2,10"]=8061 ["2,11"]=8161 ["2,12"]=8261 ["2,13"]=8361 ["2,14"]=8461 ["2,15"]=8561 ["2,16"]=8661 ["2,17"]=8761 ["2,18"]=8861 ["2,19"]=8961
  ["2,20"]=8071 ["2,21"]=8171 ["2,22"]=8271 ["2,23"]=8371 ["2,24"]=8471

  # Org3 peers (base: 9000)
  ["3,0"]=9051 ["3,1"]=9151 ["3,2"]=9251 ["3,3"]=9351 ["3,4"]=9451 ["3,5"]=9551 ["3,6"]=9651 ["3,7"]=9751 ["3,8"]=9851 ["3,9"]=9951
  ["3,10"]=9061 ["3,11"]=9161 ["3,12"]=9261 ["3,13"]=9361 ["3,14"]=9461 ["3,15"]=9561 ["3,16"]=9661 ["3,17"]=9761 ["3,18"]=9861 ["3,19"]=9961
  ["3,20"]=9071 ["3,21"]=9171 ["3,22"]=9271 ["3,23"]=9371 ["3,24"]=9471

  # Org4 peers (base: 10000)
  ["4,0"]=10051 ["4,1"]=10151 ["4,2"]=10251 ["4,3"]=10351 ["4,4"]=10451 ["4,5"]=10551 ["4,6"]=10651 ["4,7"]=10751 ["4,8"]=10851 ["4,9"]=10951
  ["4,10"]=10061 ["4,11"]=10161 ["4,12"]=10261 ["4,13"]=10361 ["4,14"]=10461 ["4,15"]=10561 ["4,16"]=10661 ["4,17"]=10761 ["4,18"]=10861 ["4,19"]=10961
  ["4,20"]=10071 ["4,21"]=10171 ["4,22"]=10271 ["4,23"]=10371 ["4,24"]=10471

  # Org5 peers (base: 11000)
  ["5,0"]=11051 ["5,1"]=11151 ["5,2"]=11251 ["5,3"]=11351 ["5,4"]=11451 ["5,5"]=11551 ["5,6"]=11651 ["5,7"]=11751 ["5,8"]=11851 ["5,9"]=11951
  ["5,10"]=11061 ["5,11"]=11161 ["5,12"]=11261 ["5,13"]=11361 ["5,14"]=11461 ["5,15"]=11561 ["5,16"]=11661 ["5,17"]=11761 ["5,18"]=11861 ["5,19"]=11961
  ["5,20"]=11071 ["5,21"]=11171 ["5,22"]=11271 ["5,23"]=11371 ["5,24"]=11471

  # Org6 peers (base: 12000)
  ["6,0"]=12051 ["6,1"]=12151 ["6,2"]=12251 ["6,3"]=12351 ["6,4"]=12451 ["6,5"]=12551 ["6,6"]=12651 ["6,7"]=12751 ["6,8"]=12851 ["6,9"]=12951
  ["6,10"]=12061 ["6,11"]=12161 ["6,12"]=12261 ["6,13"]=12361 ["6,14"]=12461 ["6,15"]=12561 ["6,16"]=12661 ["6,17"]=12761 ["6,18"]=12861 ["6,19"]=12961
  ["6,20"]=12071 ["6,21"]=12171 ["6,22"]=12271 ["6,23"]=12371 ["6,24"]=12471

  # Org7 peers (base: 13000)
  ["7,0"]=13051 ["7,1"]=13151 ["7,2"]=13251 ["7,3"]=13351 ["7,4"]=13451 ["7,5"]=13551 ["7,6"]=13651 ["7,7"]=13751 ["7,8"]=13851 ["7,9"]=13951
  ["7,10"]=13061 ["7,11"]=13161 ["7,12"]=13261 ["7,13"]=13361 ["7,14"]=13461 ["7,15"]=13561 ["7,16"]=13661 ["7,17"]=13761 ["7,18"]=13861 ["7,19"]=13961
  ["7,20"]=13071 ["7,21"]=13171 ["7,22"]=13271 ["7,23"]=13371 ["7,24"]=13471

  # Org8 peers (base: 14000)
  ["8,0"]=14051 ["8,1"]=14151 ["8,2"]=14251 ["8,3"]=14351 ["8,4"]=14451 ["8,5"]=14551 ["8,6"]=14651 ["8,7"]=14751 ["8,8"]=14851 ["8,9"]=14951
  ["8,10"]=14061 ["8,11"]=14161 ["8,12"]=14261 ["8,13"]=14361 ["8,14"]=14461 ["8,15"]=14561 ["8,16"]=14661 ["8,17"]=14761 ["8,18"]=14861 ["8,19"]=14961
  ["8,20"]=14071 ["8,21"]=14171 ["8,22"]=14271 ["8,23"]=14371 ["8,24"]=14471

  # Org9 peers (base: 15000)
  ["9,0"]=15051 ["9,1"]=15151 ["9,2"]=15251 ["9,3"]=15351 ["9,4"]=15451 ["9,5"]=15551 ["9,6"]=15651 ["9,7"]=15751 ["9,8"]=15851 ["9,9"]=15951
  ["9,10"]=15061 ["9,11"]=15161 ["9,12"]=15261 ["9,13"]=15361 ["9,14"]=15461 ["9,15"]=15561 ["9,16"]=15661 ["9,17"]=15761 ["9,18"]=15861 ["9,19"]=15961
  ["9,20"]=15071 ["9,21"]=15171 ["9,22"]=15271 ["9,23"]=15371 ["9,24"]=15471

  # Org10 peers (base: 16000)
  ["10,0"]=16051 ["10,1"]=16151 ["10,2"]=16251 ["10,3"]=16351 ["10,4"]=16451 ["10,5"]=16551 ["10,6"]=16651 ["10,7"]=16751 ["10,8"]=16851 ["10,9"]=16951
  ["10,10"]=16061 ["10,11"]=16161 ["10,12"]=16261 ["10,13"]=16361 ["10,14"]=16461 ["10,15"]=16561 ["10,16"]=16661 ["10,17"]=16761 ["10,18"]=16861 ["10,19"]=16961
  ["10,20"]=16071 ["10,21"]=16171 ["10,22"]=16271 ["10,23"]=16371 ["10,24"]=16471

  # Org11 peers (base: 17000)
  ["11,0"]=17051 ["11,1"]=17151 ["11,2"]=17251 ["11,3"]=17351 ["11,4"]=17451 ["11,5"]=17551 ["11,6"]=17651 ["11,7"]=17751 ["11,8"]=17851 ["11,9"]=17951
  ["11,10"]=17061 ["11,11"]=17161 ["11,12"]=17261 ["11,13"]=17361 ["11,14"]=17461 ["11,15"]=17561 ["11,16"]=17661 ["11,17"]=17761 ["11,18"]=17861 ["11,19"]=17961
  ["11,20"]=17071 ["11,21"]=17171 ["11,22"]=17271 ["11,23"]=17371 ["11,24"]=17471

  # Org12 peers (base: 18000)
  ["12,0"]=18051 ["12,1"]=18151 ["12,2"]=18251 ["12,3"]=18351 ["12,4"]=18451 ["12,5"]=18551 ["12,6"]=18651 ["12,7"]=18751 ["12,8"]=18851 ["12,9"]=18951
  ["12,10"]=18061 ["12,11"]=18161 ["12,12"]=18261 ["12,13"]=18361 ["12,14"]=18461 ["12,15"]=18561 ["12,16"]=18661 ["12,17"]=18761 ["12,18"]=18861 ["12,19"]=18961
  ["12,20"]=18071 ["12,21"]=18171 ["12,22"]=18271 ["12,23"]=18371 ["12,24"]=18471

  # Org13 peers (base: 19000)
  ["13,0"]=19051 ["13,1"]=19151 ["13,2"]=19251 ["13,3"]=19351 ["13,4"]=19451 ["13,5"]=19551 ["13,6"]=19651 ["13,7"]=19751 ["13,8"]=19851 ["13,9"]=19951
  ["13,10"]=19061 ["13,11"]=19161 ["13,12"]=19261 ["13,13"]=19361 ["13,14"]=19461 ["13,15"]=19561 ["13,16"]=19661 ["13,17"]=19761 ["13,18"]=19861 ["13,19"]=19961
  ["13,20"]=19071 ["13,21"]=19171 ["13,22"]=19271 ["13,23"]=19371 ["13,24"]=19471

  # Org14 peers (base: 20000)
  ["14,0"]=20051 ["14,1"]=20151 ["14,2"]=20251 ["14,3"]=20351 ["14,4"]=20451 ["14,5"]=20551 ["14,6"]=20651 ["14,7"]=20751 ["14,8"]=20851 ["14,9"]=20951
  ["14,10"]=20061 ["14,11"]=20161 ["14,12"]=20261 ["14,13"]=20361 ["14,14"]=20461 ["14,15"]=20561 ["14,16"]=20661 ["14,17"]=20761 ["14,18"]=20861 ["14,19"]=20961
  ["14,20"]=20071 ["14,21"]=20171 ["14,22"]=20271 ["14,23"]=20371 ["14,24"]=20471

  # Org15 peers (base: 21000)
  ["15,0"]=21051 ["15,1"]=21151 ["15,2"]=21251 ["15,3"]=21351 ["15,4"]=21451 ["15,5"]=21551 ["15,6"]=21651 ["15,7"]=21751 ["15,8"]=21851 ["15,9"]=21951
  ["15,10"]=21061 ["15,11"]=21161 ["15,12"]=21261 ["15,13"]=21361 ["15,14"]=21461 ["15,15"]=21561 ["15,16"]=21661 ["15,17"]=21761 ["15,18"]=21861 ["15,19"]=21961
  ["15,20"]=21071 ["15,21"]=21171 ["15,22"]=21271 ["15,23"]=21371 ["15,24"]=21471

  # Org16 peers (base: 22000)
  ["16,0"]=22051 ["16,1"]=22151 ["16,2"]=22251 ["16,3"]=22351 ["16,4"]=22451 ["16,5"]=22551 ["16,6"]=22651 ["16,7"]=22751 ["16,8"]=22851 ["16,9"]=22951
  ["16,10"]=22061 ["16,11"]=22161 ["16,12"]=22261 ["16,13"]=22361 ["16,14"]=22461 ["16,15"]=22561 ["16,16"]=22661 ["16,17"]=22761 ["16,18"]=22861 ["16,19"]=22961
  ["16,20"]=22071 ["16,21"]=22171 ["16,22"]=22271 ["16,23"]=22371 ["16,24"]=22471

  # Org17 peers (base: 23000)
  ["17,0"]=23051 ["17,1"]=23151 ["17,2"]=23251 ["17,3"]=23351 ["17,4"]=23451 ["17,5"]=23551 ["17,6"]=23651 ["17,7"]=23751 ["17,8"]=23851 ["17,9"]=23951
  ["17,10"]=23061 ["17,11"]=23161 ["17,12"]=23261 ["17,13"]=23361 ["17,14"]=23461 ["17,15"]=23561 ["17,16"]=23661 ["17,17"]=23761 ["17,18"]=23861 ["17,19"]=23961
  ["17,20"]=23071 ["17,21"]=23171 ["17,22"]=23271 ["17,23"]=23371 ["17,24"]=23471

  # Org18 peers (base: 24000)
  ["18,0"]=24051 ["18,1"]=24151 ["18,2"]=24251 ["18,3"]=24351 ["18,4"]=24451 ["18,5"]=24551 ["18,6"]=24651 ["18,7"]=24751 ["18,8"]=24851 ["18,9"]=24951
  ["18,10"]=24061 ["18,11"]=24161 ["18,12"]=24261 ["18,13"]=24361 ["18,14"]=24461 ["18,15"]=24561 ["18,16"]=24661 ["18,17"]=24761 ["18,18"]=24861 ["18,19"]=24961
  ["18,20"]=24071 ["18,21"]=24171 ["18,22"]=24271 ["18,23"]=24371 ["18,24"]=24471

  # Org19 peers (base: 25000)
  ["19,0"]=25051 ["19,1"]=25151 ["19,2"]=25251 ["19,3"]=25351 ["19,4"]=25451 ["19,5"]=25551 ["19,6"]=25651 ["19,7"]=25751 ["19,8"]=25851 ["19,9"]=25951
  ["19,10"]=25061 ["19,11"]=25161 ["19,12"]=25261 ["19,13"]=25361 ["19,14"]=25461 ["19,15"]=25561 ["19,16"]=25661 ["19,17"]=25761 ["19,18"]=25861 ["19,19"]=25961
  ["19,20"]=25071 ["19,21"]=25171 ["19,22"]=25271 ["19,23"]=25371 ["19,24"]=25471

  # Org20 peers (base: 26000)
  ["20,0"]=26051 ["20,1"]=26151 ["20,2"]=26251 ["20,3"]=26351 ["20,4"]=26451 ["20,5"]=26551 ["20,6"]=26651 ["20,7"]=26751 ["20,8"]=26851 ["20,9"]=26951
  ["20,10"]=26061 ["20,11"]=26161 ["20,12"]=26261 ["20,13"]=26361 ["20,14"]=26461 ["20,15"]=26561 ["20,16"]=26661 ["20,17"]=26761 ["20,18"]=26861 ["20,19"]=26961
  ["20,20"]=26071 ["20,21"]=26171 ["20,22"]=26271 ["20,23"]=26371 ["20,24"]=26471
)
declare -a ca_ports=(7054 8054 9054 10054 11054 12054 13054 14054 15054 16054 17054 18054 19054 20054 21054 22054 23054 24054 25054 26054)

# 循环遍历每个组织
for i in $(seq 0 $((Nums_Org-1))); do
    ORG=${orgs[$i]}
    
    # 声明peer端口变量
    for ((j=0; j<${Nums_Peer}; j++)); do
        # 使用declare来正确声明变量
        declare "P${j}PORT=${PEER_PORTS["${ORG},${j}"]}"
    done
    
    CAPORT=${ca_ports[$((ORG-1))]}
    PEERPEM="organizations/peerOrganizations/org$ORG.example.com/tlsca/tlsca.org$ORG.example.com-cert.pem"
    CAPEM="organizations/peerOrganizations/org$ORG.example.com/ca/ca.org$ORG.example.com-cert.pem"

    # 构建参数列表
    args="$ORG"
    for ((j=0; j<${Nums_Peer}; j++)); do
        varname="P${j}PORT"
        args="$args ${!varname}"
    done
    args="$args $CAPORT $PEERPEM $CAPEM"
    
    # 生成配置文件
    echo "$(json_ccp $args)" > "organizations/peerOrganizations/org$ORG.example.com/connection-org$ORG.json"
    echo "$(yaml_ccp $args)" > "organizations/peerOrganizations/org$ORG.example.com/connection-org$ORG.yaml"
    
    echo "Generated connection file for org$ORG"
done

# ORG=1
# P0PORT=7051
# CAPORT=7054
# PEERPEM=organizations/peerOrganizations/org1.example.com/tlsca/tlsca.org1.example.com-cert.pem
# CAPEM=organizations/peerOrganizations/org1.example.com/ca/ca.org1.example.com-cert.pem

# echo "$(json_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org1.example.com/connection-org1.json
# echo "$(yaml_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org1.example.com/connection-org1.yaml

# ORG=2
# P0PORT=8051
# CAPORT=8054
# PEERPEM=organizations/peerOrganizations/org2.example.com/tlsca/tlsca.org2.example.com-cert.pem
# CAPEM=organizations/peerOrganizations/org2.example.com/ca/ca.org2.example.com-cert.pem

# echo "$(json_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org2.example.com/connection-org2.json
# echo "$(yaml_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org2.example.com/connection-org2.yaml

# ORG=3
# P0PORT=9051
# CAPORT=9054
# PEERPEM=organizations/peerOrganizations/org3.example.com/tlsca/tlsca.org3.example.com-cert.pem
# CAPEM=organizations/peerOrganizations/org3.example.com/ca/ca.org3.example.com-cert.pem

# echo "$(json_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org3.example.com/connection-org3.json
# echo "$(yaml_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org3.example.com/connection-org3.yaml
